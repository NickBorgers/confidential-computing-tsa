#!/bin/sh
# Pre-push hook: thorough checks before code leaves the machine.
# Mirrors the CI checks from .github/workflows/pr-tests.yml.
#
# Checks performed:
#   - markdownlint on all Markdown files (always)
#   - cargo fmt --check (when Cargo.toml exists, matches CI)
#   - cargo clippy -- -D warnings (when Cargo.toml exists, matches CI)
#   - cargo test (when Cargo.toml exists)
#   - Docker build and smoke test (when Dockerfile exists and Docker is available)

set -e

# Change to repository root
cd "$(git rev-parse --show-toplevel)"

echo "pre-push: running checks..."

# Always run markdownlint if available
if command -v markdownlint >/dev/null 2>&1; then
    if [ -f ".markdownlint.json" ]; then
        echo "pre-push: checking markdown formatting..."
        markdownlint '**/*.md' --config .markdownlint.json
    fi
else
    echo "pre-push: markdownlint not found, skipping markdown checks"
fi

# Run Rust checks if Cargo.toml exists
if [ -f "Cargo.toml" ]; then
    # Ensure cargo is in PATH (devcontainer installs to ~/.cargo/bin)
    if ! command -v cargo >/dev/null 2>&1; then
        if [ -f "$HOME/.cargo/env" ]; then
            . "$HOME/.cargo/env"
        fi
    fi
    if command -v cargo >/dev/null 2>&1; then
        echo "pre-push: checking Rust formatting..."
        cargo fmt --check

        echo "pre-push: running clippy..."
        cargo clippy -- -D warnings

        echo "pre-push: running tests..."
        cargo test
    else
        echo "pre-push: cargo not found, skipping Rust checks"
    fi
fi

# Docker build and smoke test
if [ -f "Dockerfile" ] && command -v docker >/dev/null 2>&1; then
    echo "pre-push: running Docker build and smoke test..."
    IMAGE_TAG="cc-tsa-pre-push:$$"
    CONTAINER_NAME="pre-push-smoke-$$"

    # Use a random high port to avoid conflicts with other local services
    HOST_PORT=$(shuf -i 49152-65535 -n 1)
    echo "pre-push: using host port $HOST_PORT for smoke test"

    cleanup() {
        docker stop "$CONTAINER_NAME" >/dev/null 2>&1 || true
        docker rm "$CONTAINER_NAME" >/dev/null 2>&1 || true
        docker rmi "$IMAGE_TAG" >/dev/null 2>&1 || true
    }
    trap cleanup EXIT

    docker build -t "$IMAGE_TAG" .

    docker run -d --name "$CONTAINER_NAME" -p "$HOST_PORT:3000" "$IMAGE_TAG"

    echo "pre-push: waiting for container health check (max 30s)..."
    for i in $(seq 1 30); do
        if ! docker ps -q --filter "name=$CONTAINER_NAME" | grep -q .; then
            echo "pre-push: container exited unexpectedly!"
            docker logs "$CONTAINER_NAME"
            exit 1
        fi

        if curl -sf "http://localhost:$HOST_PORT/" >/dev/null 2>&1; then
            echo "pre-push: container smoke test passed"
            break
        fi

        if [ "$i" -eq 30 ]; then
            echo "pre-push: container failed to become healthy within 30 seconds"
            docker logs "$CONTAINER_NAME"
            exit 1
        fi

        sleep 1
    done
else
    echo "pre-push: skipping Docker smoke test (no Dockerfile or Docker not available)"
fi

echo "pre-push: all checks passed."
