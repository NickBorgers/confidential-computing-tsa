#!/bin/sh
# Pre-commit hook: fast checks only.
# Runs formatting and lint checks to catch issues before they enter version control.
#
# Checks performed:
#   - markdownlint on all Markdown files (always)
#   - cargo fmt --check (when Cargo.toml exists, matches CI)

set -e

# Change to repository root
cd "$(git rev-parse --show-toplevel)"

echo "pre-commit: running checks..."

# Always run markdownlint if available
if command -v markdownlint >/dev/null 2>&1; then
    if [ -f ".markdownlint.json" ]; then
        echo "pre-commit: checking markdown formatting..."
        markdownlint '**/*.md' --config .markdownlint.json
    fi
else
    echo "pre-commit: markdownlint not found, skipping markdown checks"
fi

# Run Rust formatting check if Cargo.toml exists
if [ -f "Cargo.toml" ]; then
    # Ensure cargo is in PATH (devcontainer installs to ~/.cargo/bin)
    if ! command -v cargo >/dev/null 2>&1; then
        if [ -f "$HOME/.cargo/env" ]; then
            . "$HOME/.cargo/env"
        fi
    fi
    if command -v cargo >/dev/null 2>&1; then
        echo "pre-commit: checking Rust formatting..."
        cargo fmt --check
    else
        echo "pre-commit: cargo not found, skipping Rust formatting check"
    fi
fi

echo "pre-commit: all checks passed."
