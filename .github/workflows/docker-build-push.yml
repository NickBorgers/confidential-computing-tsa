name: Build and Push Docker Image

# This workflow runs ONLY on pushes to main/master or version tags
# It builds, tests, and pushes the Docker image to ghcr.io
# For PR testing, see pr-tests.yml instead
#
# NOTE: This workflow requires an application Dockerfile at the repository root.
# It will skip gracefully if no Dockerfile exists yet.

on:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  check-files:
    name: Check Repository Files
    runs-on: ubuntu-latest
    outputs:
      has_cargo_toml: ${{ steps.check.outputs.has_cargo_toml }}
      has_dockerfile: ${{ steps.check.outputs.has_dockerfile }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for key files
        id: check
        run: |
          if [ -f Cargo.toml ]; then
            echo "has_cargo_toml=true" >> $GITHUB_OUTPUT
          else
            echo "has_cargo_toml=false" >> $GITHUB_OUTPUT
          fi
          if [ -f Dockerfile ]; then
            echo "has_dockerfile=true" >> $GITHUB_OUTPUT
          else
            echo "has_dockerfile=false" >> $GITHUB_OUTPUT
          fi

  test:
    name: Run Rust Tests
    runs-on: ubuntu-latest
    needs: check-files
    # Only run if there's actual Rust code to test
    if: needs.check-files.outputs.has_cargo_toml == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry and build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: cargo-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: cargo-${{ runner.os }}-

      - name: Run unit tests
        run: cargo test --lib --bins

      - name: Run integration tests
        run: |
          # Check if there are any integration test files
          if find cvm/tests wrapper/tests -name "*.rs" 2>/dev/null | grep -q .; then
            echo "Running integration tests..."
            cargo test --test '*'
          else
            echo "No integration test files found, skipping integration tests"
            exit 0
          fi

  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: [check-files, test]
    # Only run if an application Dockerfile exists
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped') && needs.check-files.outputs.has_dockerfile == 'true'
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

      - name: Image digest
        run: echo "Image pushed with digest ${{ steps.build-and-push.outputs.digest }}"

  verify-pushed-image:
    name: Verify Pushed Image Works
    runs-on: ubuntu-latest
    needs: build-and-push
    if: needs.build-and-push.result == 'success'
    permissions:
      contents: read
      packages: read

    steps:
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull and test pushed image
        run: |
          # Use the SHA-based tag for exact image verification
          # The metadata-action uses prefix={{branch}}- so tag is main-<sha7> or master-<sha7>
          # Note: Docker requires lowercase image names; github.repository preserves case
          BRANCH="${GITHUB_REF_NAME}"
          IMAGE_NAME_LOWER=$(echo "${{ env.IMAGE_NAME }}" | tr '[:upper:]' '[:lower:]')
          IMAGE="${{ env.REGISTRY }}/${IMAGE_NAME_LOWER}:${BRANCH}-${GITHUB_SHA::7}"
          echo "Testing image: $IMAGE"

          # Pull the image we just pushed
          docker pull "$IMAGE"

          echo "Running container startup smoke test..."

          # Start container
          docker run -d --name prod-smoke-test \
            -p 3000:3000 \
            "$IMAGE"

          # Wait for container to either become healthy or crash
          echo "Waiting for container to start (max 30 seconds)..."
          for i in $(seq 1 30); do
            # Check if container is still running
            if ! docker ps -q --filter "name=prod-smoke-test" | grep -q .; then
              echo "Container exited unexpectedly!"
              echo ""
              echo "Container logs:"
              docker logs prod-smoke-test
              docker rm prod-smoke-test || true
              exit 1
            fi

            # Check if health endpoint responds
            if curl -sf http://localhost:3000/ >/dev/null 2>&1; then
              echo "Container started successfully (health check passed)"
              break
            fi

            if [ $i -eq 30 ]; then
              echo "Container failed to become healthy within 30 seconds"
              echo ""
              echo "Container logs:"
              docker logs prod-smoke-test
              docker stop prod-smoke-test || true
              docker rm prod-smoke-test || true
              exit 1
            fi

            sleep 1
          done

          # Cleanup
          docker stop prod-smoke-test
          docker rm prod-smoke-test
          echo ""
          echo "==============================================="
          echo "    REGISTRY-PULLED IMAGE VERIFICATION"
          echo "==============================================="
          echo "Image pulled successfully from ghcr.io"
          echo "Container starts without panic"
          echo "Health endpoint responds"
          echo "Registry-pulled image is production-ready"
          echo "==============================================="
