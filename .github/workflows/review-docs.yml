name: "Review: Documentation"

# Reusable workflow - checks if documentation needs updating for code/content changes
# Called by claude-code-review.yml orchestrator

on:
  workflow_call:
    inputs:
      pr_number:
        required: true
        type: string
      pr_title:
        required: true
        type: string
      pr_body_b64:
        required: true
        type: string
      head_ref:
        required: true
        type: string
      head_repo:
        required: true
        type: string
      issue_number:
        required: true
        type: string
      issue_title:
        required: true
        type: string
      issue_body_b64:
        required: true
        type: string
      devcontainer_image:
        required: true
        type: string
    secrets:
      CLAUDE_CODE_OAUTH_TOKEN:
        required: true
      WORKFLOW_PAT:
        required: true

jobs:
  docs-review:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      packages: read

    steps:
      - name: Verify tests passed on current commit
        id: verify-tests
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          HEAD_SHA=$(gh api repos/${{ github.repository }}/pulls/${{ inputs.pr_number }} --jq '.head.sha')
          echo "Checking test status for commit $HEAD_SHA"

          MAX_ATTEMPTS=40
          ATTEMPT=1
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            STATUS=$(gh api repos/${{ github.repository }}/commits/$HEAD_SHA/check-runs --jq '[.check_runs[] | select(.name == "All Required Tests")] | sort_by(.completed_at) | last | .conclusion' 2>/dev/null || echo "")

            if [ "$STATUS" = "success" ]; then
              echo "All Required Tests passed on current commit"
              echo "verified=true" >> $GITHUB_OUTPUT
              exit 0
            fi

            if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
              echo "Attempt $ATTEMPT/$MAX_ATTEMPTS: Check run not found yet (status: ${STATUS:-not found}), waiting 10s..."
              sleep 10
            fi
            ATTEMPT=$((ATTEMPT + 1))
          done

          echo "Tests have not passed on current commit after $MAX_ATTEMPTS attempts"
          echo "verified=false" >> $GITHUB_OUTPUT

      - name: Checkout PR branch
        if: steps.verify-tests.outputs.verified == 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.head_ref }}
          repository: ${{ inputs.head_repo }}
          fetch-depth: 0
          token: ${{ secrets.WORKFLOW_PAT }}

      - name: Pull latest changes
        if: steps.verify-tests.outputs.verified == 'true'
        run: git pull origin ${{ inputs.head_ref }} || true

      - name: Create gh config directory for devcontainer mount
        if: steps.verify-tests.outputs.verified == 'true'
        run: mkdir -p ~/.config/gh

      - name: Log in to GHCR
        if: steps.verify-tests.outputs.verified == 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Documentation review in devcontainer
        if: steps.verify-tests.outputs.verified == 'true'
        uses: devcontainers/ci@v0.3
        with:
          imageName: ${{ inputs.devcontainer_image }}
          cacheFrom: ${{ inputs.devcontainer_image }}
          push: never
          env: |
            CLAUDE_CODE_OAUTH_TOKEN=${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
            GH_TOKEN=${{ secrets.WORKFLOW_PAT }}
            PR_NUMBER=${{ inputs.pr_number }}
            PR_TITLE=${{ inputs.pr_title }}
            PR_BODY_B64=${{ inputs.pr_body_b64 }}
            ISSUE_NUMBER=${{ inputs.issue_number }}
            ISSUE_TITLE=${{ inputs.issue_title }}
            ISSUE_BODY_B64=${{ inputs.issue_body_b64 }}
            HEAD_REF=${{ inputs.head_ref }}
          runCmd: |
            PR_BODY=$(echo "$PR_BODY_B64" | base64 -d 2>/dev/null || echo "")
            ISSUE_BODY=$(echo "$ISSUE_BODY_B64" | base64 -d 2>/dev/null || echo "")

            claude --print \
              --verbose \
              --output-format stream-json \
              --model opus \
              --dangerously-skip-permissions \
              --max-turns 200 \
              "You are a DOCUMENTATION specialist reviewing PR #${PR_NUMBER}.

            **CRITICAL: BE BRIEF. Only report documentation that MUST be updated.**
            Do NOT list docs that don't need changes. Do NOT provide checklists of N/A items.
            If no docs need updating, post a short approval and move on.

            Context (if available):
            Issue #${ISSUE_NUMBER}: ${ISSUE_TITLE}
            PR: ${PR_TITLE}

            Run \`git diff origin/main...HEAD\` to see changes.

            Only check docs relevant to the actual changes:
            - Architecture changes -> docs/01-architecture-overview.md
            - Confidential computing changes -> docs/02-confidential-computing-and-time.md
            - Crypto/threshold changes -> docs/03-quantum-safe-threshold-crypto.md
            - Failure mode changes -> docs/04-failure-modes-and-recovery.md
            - Operations changes -> docs/05-operations-and-deployment.md
            - RFC compliance changes -> docs/06-rfc3161-compliance.md
            - Threat model changes -> docs/07-threat-model.md
            - Performance changes -> docs/08-throughput-and-scaling.md
            - Workflow changes (.github/workflows/*.yml) -> update relevant docs

            If updates needed, make changes directly and push.
            BEFORE PUSHING: rebase with \`git pull --rebase origin ${HEAD_REF}\`

            Post exactly ONE comment using:
            gh pr comment ${PR_NUMBER} --body '## Documentation Review

            [If no updates needed: \"Approved - No doc updates required\" and stop here]

            ### Updates Required
            [Only list docs that MUST be updated. Skip if none.]

            ### Updates Applied
            [List commits pushed, if any. Skip section if none.]

            ### Conclusion
            [Approved | Needs changes | Blocking issues]'" < /dev/null 2>&1 | tee /workspaces/confidential-computing-tsa/docs-review-output.jsonl

      - name: Upload documentation review output
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: docs-review-output
          path: docs-review-output.jsonl
          retention-days: 7
