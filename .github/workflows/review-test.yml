name: "Review: Tests"

# Reusable workflow - reviews test coverage and quality
# Only meaningful when Rust code is present
# Called by claude-code-review.yml orchestrator

on:
  workflow_call:
    inputs:
      pr_number:
        required: true
        type: string
      head_ref:
        required: true
        type: string
      head_repo:
        required: true
        type: string
      devcontainer_image:
        required: true
        type: string
    secrets:
      CLAUDE_CODE_OAUTH_TOKEN:
        required: true
      WORKFLOW_PAT:
        required: true

jobs:
  test-review:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      packages: read

    steps:
      - name: Verify tests passed on current commit
        id: verify-tests
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          HEAD_SHA=$(gh api repos/${{ github.repository }}/pulls/${{ inputs.pr_number }} --jq '.head.sha')
          echo "Checking test status for commit $HEAD_SHA"

          MAX_ATTEMPTS=40
          ATTEMPT=1
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            STATUS=$(gh api repos/${{ github.repository }}/commits/$HEAD_SHA/check-runs --jq '[.check_runs[] | select(.name == "All Required Tests")] | sort_by(.completed_at) | last | .conclusion' 2>/dev/null || echo "")

            if [ "$STATUS" = "success" ]; then
              echo "All Required Tests passed on current commit"
              echo "verified=true" >> $GITHUB_OUTPUT
              exit 0
            fi

            if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
              echo "Attempt $ATTEMPT/$MAX_ATTEMPTS: Check run not found yet (status: ${STATUS:-not found}), waiting 10s..."
              sleep 10
            fi
            ATTEMPT=$((ATTEMPT + 1))
          done

          echo "Tests have not passed on current commit after $MAX_ATTEMPTS attempts"
          echo "verified=false" >> $GITHUB_OUTPUT

      - name: Checkout PR branch
        if: steps.verify-tests.outputs.verified == 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.head_ref }}
          repository: ${{ inputs.head_repo }}
          fetch-depth: 0
          token: ${{ secrets.WORKFLOW_PAT }}

      - name: Pull latest changes
        if: steps.verify-tests.outputs.verified == 'true'
        run: git pull origin ${{ inputs.head_ref }} || true

      - name: Create mount directories for devcontainer
        if: steps.verify-tests.outputs.verified == 'true'
        run: mkdir -p ~/.config/gh ~/.claude ~/.azure

      - name: Log in to GHCR
        if: steps.verify-tests.outputs.verified == 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Test review in devcontainer
        if: steps.verify-tests.outputs.verified == 'true'
        uses: devcontainers/ci@v0.3
        with:
          imageName: ${{ inputs.devcontainer_image }}
          cacheFrom: ${{ inputs.devcontainer_image }}
          push: never
          env: |
            CLAUDE_CODE_OAUTH_TOKEN=${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
            GH_TOKEN=${{ secrets.WORKFLOW_PAT }}
            PR_NUMBER=${{ inputs.pr_number }}
            HEAD_REF=${{ inputs.head_ref }}
          runCmd: |
            # Using Sonnet: Checklist-based review with clear criteria
            claude --print \
              --verbose \
              --output-format stream-json \
              --model sonnet \
              --dangerously-skip-permissions \
              --max-turns 200 \
              "You are a QA tester for PR #${PR_NUMBER}.

            **CRITICAL: BE BRIEF. Only report issues that require action from the PR author.**
            Do NOT list files reviewed. Do NOT describe what tests do. Do NOT praise good tests.
            If there are no actionable issues, post a short approval and move on.

            Check changed files (\`git diff origin/main...HEAD --name-only\`):

            FOR RUST CODE: Check for missing tests, proper use of #[cfg(test)] modules,
            async tests using #[tokio::test], missing edge case coverage, tests that
            rely on timing or external state.
            FOR WORKFLOWS: Validate YAML syntax, check action refs, verify permissions.
            FOR CONFIG: Validate syntax.

            Run \`cargo test\` to verify.

            For HIGH SEVERITY issues, fix directly and push.
            BEFORE PUSHING: rebase with \`git pull --rebase origin ${HEAD_REF}\`

            Post exactly ONE comment using:
            gh pr comment ${PR_NUMBER} --body '## Test Review

            [If no issues: \"Approved - Tests look good\" and stop here]

            ### Issues Found
            [Only list actionable items: missing tests, flaky tests, etc. Skip if none.]

            ### Fixes Applied
            [List commits pushed, if any. Skip section if none.]

            ### Conclusion
            [Approved | Needs changes | Blocking issues]'" < /dev/null 2>&1 | tee /workspaces/confidential-computing-tsa/test-review-output.jsonl

      - name: Upload test review output
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-review-output
          path: test-review-output.jsonl
          retention-days: 7
